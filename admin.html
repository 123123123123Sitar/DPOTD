<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.PotD Admin Portal</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; }
        #loginScreen { display: flex; align-items: center; justify-content: center; min-height: 100vh; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 400px; width: 90%; }
        .login-box h1 { color: #333; margin-bottom: 10px; font-size: 28px; text-align: center; }
        .login-box p { color: #666; margin-bottom: 30px; text-align: center; }
        .login-form-group { margin-bottom: 20px; }
        .login-form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .login-form-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; transition: border-color 0.3s; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .login-form-group input:focus { outline: none; border-color: #667eea; }
        .login-error { display: none; background: #fee; color: #c33; padding: 10px; border-radius: 6px; margin-bottom: 20px; font-size: 14px; text-align: center; }
        .login-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .login-btn:hover { transform: translateY(-2px); }
        .login-btn:active { transform: translateY(0); }
        #adminPanel { display: none; }
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        h1 { color: #000; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #E3E3E3; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 16px; font-weight: 600; color: #666; transition: all 0.3s; }
        .tab.active { color: #EA5A2F; border-bottom-color: #EA5A2F; }
        .tab-content { display: none; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #000; font-weight: 600; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #E3E3E3; border-radius: 6px; font-size: 16px; transition: border-color 0.3s; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #EA5A2F; }
        textarea { font-family: 'Courier New', monospace; resize: vertical; }
        .btn { background: #EA5A2F; color: white; padding: 12px 30px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-2px); background: #d84a1f; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .status { padding: 15px; border-radius: 6px; margin-top: 20px; display: none; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; display: block; }
        .question-group { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #EA5A2F; }
        .question-group h3 { margin-bottom: 15px; color: #000; }
        .submission-card { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .submission-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef; }
        .submission-header h3 { margin: 0; color: #212529; display: flex; align-items: center; gap: 10px; }
        .graded-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .graded-badge.graded { background: #d4edda; color: #155724; }
        .graded-badge.pending { background: #fff3cd; color: #856404; }
        .submission-details { display: flex; flex-direction: column; gap: 10px; }
        .detail-item { padding: 8px 0; }
        .detail-label { font-weight: 600; color: #495057; margin-right: 8px; }
        .correct { color: #28a745; font-weight: bold; }
        .incorrect { color: #dc3545; font-weight: bold; }
        .violation-details { margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; }
        .violation-details ul { margin: 5px 0 0 20px; padding: 0; }
        .violation-details li { color: #856404; font-size: 14px; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .image-upload-section { margin-top: 15px; padding: 15px; background: #fff; border: 2px dashed #E3E3E3; border-radius: 6px; }
        .image-preview { margin-top: 10px; max-width: 100%; }
        .image-preview img { max-width: 100%; max-height: 300px; border-radius: 4px; border: 1px solid #E3E3E3; }
        .latex-editor-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .latex-input-section, .latex-preview-section { background: #fff; border: 2px solid #E3E3E3; border-radius: 8px; padding: 15px; min-height: 300px; }
        .latex-input-section h4, .latex-preview-section h4 { color: #EA5A2F; margin-bottom: 10px; font-size: 14px; }
        .latex-input-section textarea { width: 100%; height: calc(100% - 40px); min-height: 250px; border: 1px solid #ddd; border-radius: 4px; padding: 10px; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical; }
        .latex-preview-section .preview-content { min-height: 250px; padding: 10px; background: #fafafa; border: 1px solid #ddd; border-radius: 4px; overflow-y: auto; }
        .filters-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-group label { font-size: 14px; margin-bottom: 5px; }
        .filter-group select { padding: 8px; }
        .navigation-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .nav-buttons { display: flex; gap: 10px; }
        .nav-btn { padding: 8px 16px; background: #EA5A2F; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .student-selector { flex: 1; max-width: 400px; margin: 0 20px; }
        .student-selector select { width: 100%; }
        .logo-footer { text-align: center; margin-top: 40px; padding: 20px; color: #666; }
        .logo-footer img { max-width: 150px; margin-bottom: 10px; }
        .override-controls { margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107; }
        .override-controls h4 { color: #856404; margin-bottom: 10px; font-size: 14px; }
        .override-buttons { display: flex; gap: 10px; }
        .override-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .override-btn.correct { background: #28a745; color: white; }
        .override-btn.incorrect { background: #dc3545; color: white; }
        @media (max-width: 768px) { .latex-editor-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-box">
            <h1>Admin Login</h1>
            <p>Enter credentials to access the admin portal</p>
            <div id="loginError" class="login-error"></div>
            <div class="login-form-group">
                <label for="usernameInput">Username</label>
                <input type="text" id="usernameInput" placeholder="Enter admin username" autocomplete="off">
            </div>
            <div class="login-form-group">
                <label for="passwordInput">Password</label>
                <input type="password" id="passwordInput" onkeypress="handlePasswordKeyPress(event)" placeholder="Enter admin password" autocomplete="off">
            </div>
            <button class="login-btn" onclick="checkPassword()">Login</button>
        </div>
    </div>

    <div id="adminPanel">
        <div class="container">
            <h1>D.PotD Admin Portal</h1>
            <p class="subtitle">Manage Questions, Schedule, Users & View Submissions</p>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('questions')">Questions</button>
                <button class="tab" onclick="switchTab('schedule')">Schedule</button>
                <button class="tab" onclick="switchTab('settings')">Settings</button>
                <button class="tab" onclick="switchTab('users')">Users</button>
                <button class="tab" onclick="switchTab('submissions')">Submissions</button>
            </div>
            
            <div id="questions" class="tab-content active">
                <div class="form-group">
                    <label>Select Day:</label>
                    <select id="questionDay" onchange="loadQuestions()">
                        <option value="1">Day 1</option>
                        <option value="2">Day 2</option>
                        <option value="3">Day 3</option>
                        <option value="4">Day 4</option>
                        <option value="5">Day 5</option>
                    </select>
                </div>
                
                <div class="question-group">
                    <h3>Question 1 (Auto-Graded) - 5 Points</h3>
                    <div class="form-group">
                        <label>Question Text:</label>
                        <textarea id="q1Text" rows="3"></textarea>
                    </div>
                    <div class="image-upload-section">
                        <label>Question Image (Optional):</label>
                        <input type="file" id="q1Image" accept="image/*" onchange="handleImageUpload(1)">
                        <div id="q1ImagePreview" class="image-preview"></div>
                        <input type="hidden" id="q1ImageData">
                    </div>
                    <div class="form-group">
                        <label>Answer (numbers only):</label>
                        <input type="text" id="q1Answer" placeholder="e.g., 42 or -15">
                    </div>
                </div>
                
                <div class="question-group">
                    <h3>Question 2 (Auto-Graded) - 5 Points</h3>
                    <div class="form-group">
                        <label>Question Text:</label>
                        <textarea id="q2Text" rows="3"></textarea>
                    </div>
                    <div class="image-upload-section">
                        <label>Question Image (Optional):</label>
                        <input type="file" id="q2Image" accept="image/*" onchange="handleImageUpload(2)">
                        <div id="q2ImagePreview" class="image-preview"></div>
                        <input type="hidden" id="q2ImageData">
                    </div>
                    <div class="form-group">
                        <label>Answer (numbers only):</label>
                        <input type="text" id="q2Answer" placeholder="e.g., 42 or -15">
                    </div>
                </div>
                
                <div class="question-group">
                    <h3>Question 3 (Manually Graded - Proof/Explanation) - 10 Points</h3>
                    <div class="form-group">
                        <label>Question Text:</label>
                        <textarea id="q3Text" rows="3"></textarea>
                    </div>
                    <div class="image-upload-section">
                        <label>Question Image (Optional):</label>
                        <input type="file" id="q3Image" accept="image/*" onchange="handleImageUpload(3)">
                        <div id="q3ImagePreview" class="image-preview"></div>
                        <input type="hidden" id="q3ImageData">
                    </div>
                    <div class="form-group">
                        <label>Sample Answer/Rubric:</label>
                        <textarea id="q3Answer" rows="3"></textarea>
                    </div>
                </div>
                
                <button class="btn" onclick="saveQuestions()">Save Questions</button>
                <div id="questionStatus" class="status"></div>
            </div>
            
            <div id="schedule" class="tab-content">
                <p style="color: #666; margin-bottom: 20px;">Set when each day's test becomes available. Each day automatically starts at 12:00 AM and must be at least 24 hours after the previous day.</p>
                
                <div class="form-group">
                    <label>Day 1 Opens:</label>
                    <input type="date" id="day1">
                </div>
                <div class="form-group">
                    <label>Day 2 Opens:</label>
                    <input type="date" id="day2">
                </div>
                <div class="form-group">
                    <label>Day 3 Opens:</label>
                    <input type="date" id="day3">
                </div>
                <div class="form-group">
                    <label>Day 4 Opens:</label>
                    <input type="date" id="day4">
                </div>
                <div class="form-group">
                    <label>Day 5 Opens:</label>
                    <input type="date" id="day5">
                </div>
                
                <button class="btn" onclick="saveSchedule()">Save Schedule</button>
                <div id="scheduleStatus" class="status"></div>
            </div>
            
            <div id="settings" class="tab-content">
                <h3 style="margin-bottom: 20px;">Admin Account Settings</h3>
                <div class="form-group">
                    <label>Admin Name:</label>
                    <input type="text" id="adminName">
                </div>
                <div class="form-group">
                    <label>Admin Email:</label>
                    <input type="email" id="adminEmail">
                </div>
                <div class="form-group">
                    <label>Admin Username:</label>
                    <input type="text" id="adminUsername">
                </div>
                <div class="form-group">
                    <label>Admin Password:</label>
                    <input type="text" id="adminPasswordField">
                </div>
                
                <hr style="margin: 30px 0; border: none; border-top: 2px solid #E3E3E3;">
                
                <h3 style="margin-bottom: 20px;">Test Settings</h3>
                <div class="form-group">
                    <label>Test Duration (minutes):</label>
                    <input type="number" id="testDuration" value="120">
                </div>
                
                <button class="btn" onclick="saveSettings()">Save Settings</button>
                <div id="settingsStatus" class="status"></div>
            </div>
            
            <div id="users" class="tab-content">
                <h2 style="margin-bottom: 20px;">User Management</h2>
                
                <div style="background: #f8f9fa; padding: 30px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #EA5A2F;">
                    <h3 style="margin-bottom: 20px;">Add New User</h3>
                    <div class="form-group">
                        <label>Full Name:</label>
                        <input type="text" id="newUserName" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="newUserEmail" placeholder="student@example.com">
                    </div>
                    <p style="color: #666; font-size: 14px; margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 4px;">
                        A password will be automatically generated and emailed to the user.
                    </p>
                    <button class="btn" onclick="addUser()" style="margin-top: 15px;">Add User</button>
                </div>
                
                <h3 style="margin-bottom: 20px;">Registered Users</h3>
                <div class="btn-group">
                    <button class="btn" onclick="loadUsers()">Refresh Users</button>
                </div>
                <div id="usersContainer"></div>
                <div id="usersStatus" class="status"></div>
            </div>
            
            <div id="submissions" class="tab-content">
                <div class="btn-group">
                    <button class="btn" onclick="loadSubmissions()">Refresh Submissions</button>
                    <button class="btn" onclick="exportToCSV()" style="background: #28a745;">Export to CSV</button>
                </div>
                
                <div class="filters-section">
                    <div class="filter-group">
                        <label>Filter by Day:</label>
                        <select id="filterDay" onchange="filterSubmissions()">
                            <option value="all">All Days</option>
                            <option value="1">Day 1</option>
                            <option value="2">Day 2</option>
                            <option value="3">Day 3</option>
                            <option value="4">Day 4</option>
                            <option value="5">Day 5</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Filter by Student:</label>
                        <select id="filterStudent" onchange="filterSubmissions()">
                            <option value="all">All Students</option>
                        </select>
                    </div>
                </div>
                
                <div class="navigation-controls" id="navControls" style="display: none;">
                    <div class="nav-buttons">
                        <button class="nav-btn" id="prevBtn" onclick="navigateSubmission(-1)">Previous</button>
                    </div>
                    <div class="student-selector">
                        <select id="submissionSelector" onchange="selectSubmission()"></select>
                    </div>
                    <div class="nav-buttons">
                        <button class="nav-btn" id="nextBtn" onclick="navigateSubmission(1)">Next</button>
                    </div>
                </div>
                
                <div id="submissionsContainer"></div>
                <div id="submissionsStatus" class="status"></div>
            </div>
            
            <div class="logo-footer">
                <p>D.tech Math Club</p>
                <p style="font-size: 12px; margin-top: 5px;">2025 D.tech Problems of the Day</p>
            </div>
        </div>
    </div>
    
    <script src="https://script.google.com/macros/s/AKfycbxq3HkS8-PG1feQxby_D3G587ULSla9V0heQT8rw6PlS2MlC2ZGjLnbRq7AUmam3Y0aoQ/exec"></script>
    <script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxq3HkS8-PG1feQxby_D3G587ULSla9V0heQT8rw6PlS2MlC2ZGjLnbRq7AUmam3Y0aoQ/exec';
const ADMIN_USERNAME = 'meipetersgoat';
const ADMIN_PASSWORD = 'SitarsTheGOAT!';

let cachedSubmissions = [];
let filteredSubmissions = [];
let currentSubmissionIndex = 0;
let isAuthenticated = false;
let latexUpdateTimers = {};

function checkPassword() {
    const username = document.getElementById('usernameInput').value;
    const password = document.getElementById('passwordInput').value;
    const loginError = document.getElementById('loginError');
    
    if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        isAuthenticated = true;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        loadQuestions();
        loadSettings();
    } else {
        loginError.textContent = 'Incorrect username or password';
        loginError.style.display = 'block';
        document.getElementById('usernameInput').value = '';
        document.getElementById('passwordInput').value = '';
    }
}

function handlePasswordKeyPress(event) {
    if (event.key === 'Enter') checkPassword();
}

function showStatus(elementId, message, type) {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.className = 'status ' + type;
    el.style.display = 'block';
}

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
    if (tabName === 'questions') loadQuestions();
    if (tabName === 'schedule') loadSchedule();
    if (tabName === 'settings') loadSettings();
    if (tabName === 'submissions') loadSubmissions();
    if (tabName === 'users') loadUsers();
}

function handleImageUpload(questionNum) {
    const input = document.getElementById(`q${questionNum}Image`);
    const preview = document.getElementById(`q${questionNum}ImagePreview`);
    const dataField = document.getElementById(`q${questionNum}ImageData`);
    const file = input.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        input.value = '';
        return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        const base64 = e.target.result;
        dataField.value = base64;
        preview.innerHTML = `<img src="${base64}" alt="Question ${questionNum} Image"><button onclick="removeImage(${questionNum})" style="margin-top: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Image</button>`;
    };
    reader.readAsDataURL(file);
}

function removeImage(questionNum) {
    document.getElementById(`q${questionNum}Image`).value = '';
    document.getElementById(`q${questionNum}ImageData`).value = '';
    document.getElementById(`q${questionNum}ImagePreview`).innerHTML = '';
}

async function loadQuestions() {
    if (!isAuthenticated) return;
    const day = document.getElementById('questionDay').value;
    if (!SCRIPT_URL || SCRIPT_URL.includes('YOUR_DEPLOYMENT_ID')) {
        showStatus('questionStatus', 'Error: Script URL not configured', 'error');
        return;
    }
    try {
        const response = await fetch(`${SCRIPT_URL}?action=getQuestions&day=${day}`);
        const data = await response.json();
        if (data.error) {
            ['q1Text','q1Answer','q1ImageData','q2Text','q2Answer','q2ImageData','q3Text','q3Answer','q3ImageData'].forEach(id => document.getElementById(id).value = '');
            ['q1ImagePreview','q2ImagePreview','q3ImagePreview'].forEach(id => document.getElementById(id).innerHTML = '');
        } else {
            document.getElementById('q1Text').value = data.q1_text || '';
            document.getElementById('q1Answer').value = data.q1_answer || '';
            if (data.q1_image) {
                document.getElementById('q1ImageData').value = data.q1_image;
                document.getElementById('q1ImagePreview').innerHTML = `<img src="${data.q1_image}" alt="Question 1 Image"><button onclick="removeImage(1)" style="margin-top: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Image</button>`;
            }
            document.getElementById('q2Text').value = data.q2_text || '';
            document.getElementById('q2Answer').value = data.q2_answer || '';
            if (data.q2_image) {
                document.getElementById('q2ImageData').value = data.q2_image;
                document.getElementById('q2ImagePreview').innerHTML = `<img src="${data.q2_image}" alt="Question 2 Image"><button onclick="removeImage(2)" style="margin-top: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Image</button>`;
            }
            document.getElementById('q3Text').value = data.q3_text || '';
            document.getElementById('q3Answer').value = data.q3_answer || '';
            if (data.q3_image) {
                document.getElementById('q3ImageData').value = data.q3_image;
                document.getElementById('q3ImagePreview').innerHTML = `<img src="${data.q3_image}" alt="Question 3 Image"><button onclick="removeImage(3)" style="margin-top: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Image</button>`;
            }
        }
    } catch (error) {
        showStatus('questionStatus', 'Error loading questions: ' + error.message, 'error');
    }
}

async function saveQuestions() {
    if (!isAuthenticated) return;
    const day = document.getElementById('questionDay').value;
    const data = {
        action: 'saveQuestions', day: day,
        q1_text: document.getElementById('q1Text').value,
        q1_answer: document.getElementById('q1Answer').value,
        q1_image: document.getElementById('q1ImageData').value || '',
        q2_text: document.getElementById('q2Text').value,
        q2_answer: document.getElementById('q2Answer').value,
        q2_image: document.getElementById('q2ImageData').value || '',
        q3_text: document.getElementById('q3Text').value,
        q3_answer: document.getElementById('q3Answer').value,
        q3_image: document.getElementById('q3ImageData').value || ''
    };
    showStatus('questionStatus', 'Saving...', 'info');
    try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        if (result.success) {
            showStatus('questionStatus', 'Questions saved successfully!', 'success');
        } else {
            showStatus('questionStatus', 'Error: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showStatus('questionStatus', 'Error saving: ' + error.message, 'error');
    }
}

async function loadSchedule() {
    if (!isAuthenticated) return;
    try {
        const response = await fetch(`${SCRIPT_URL}?action=getSchedule`);
        const data = await response.json();
        for (let i = 1; i <= 5; i++) {
            const value = data[`day${i}`];
            if (value) {
                const date = new Date(value);
                const formatted = date.toISOString().slice(0, 10);
                document.getElementById(`day${i}`).value = formatted;
            }
        }
    } catch (error) {
        showStatus('scheduleStatus', 'Error loading schedule: ' + error.message, 'error');
    }
}

async function saveSchedule() {
    if (!isAuthenticated) return;
    const data = { action: 'saveSchedule' };
    let prevDate = null;
    for (let i = 1; i <= 5; i++) {
        const value = document.getElementById(`day${i}`).value;
        if (value) {
            const date = new Date(value);
            if (prevDate) {
                const diffTime = date - prevDate;
                const diffDays = diffTime / (1000 * 60 * 60 * 24);
                if (diffDays < 1) {
                    showStatus('scheduleStatus', `Day ${i} must be at least 24 hours after Day ${i-1}`, 'error');
                    return;
                }
            }
            date.setHours(0, 0, 0, 0);
            data[`day${i}`] = date.toISOString().replace('T', ' ').slice(0, 19);
            prevDate = date;
        }
    }
    showStatus('scheduleStatus', 'Saving...', 'info');
    try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        if (result.success) {
            showStatus('scheduleStatus', 'Schedule saved successfully!', 'success');
        } else {
            showStatus('scheduleStatus', 'Error: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showStatus('scheduleStatus', 'Error saving: ' + error.message, 'error');
    }
}

async function loadSettings() {
    if (!isAuthenticated) return;
    try {
        const response = await fetch(`${SCRIPT_URL}?action=getSettings`);
        const data = await response.json();
        document.getElementById('adminName').value = data['Admin Name'] || '';
        document.getElementById('adminEmail').value = data['Admin Email'] || '';
        document.getElementById('adminUsername').value = data['Admin Username'] || ADMIN_USERNAME;
        document.getElementById('adminPasswordField').value = data['Admin Password'] || ADMIN_PASSWORD;
        document.getElementById('testDuration').value = data['Test Duration'] || 120;
    } catch (error) {
        showStatus('settingsStatus', 'Error loading settings: ' + error.message, 'error');
    }
}

async function saveSettings() {
    if (!isAuthenticated) return;
    const data = {
        action: 'saveSettings',
        'Admin Name': document.getElementById('adminName').value,
        'Admin Email': document.getElementById('adminEmail').value,
        'Admin Username': document.getElementById('adminUsername').value,
        'Admin Password': document.getElementById('adminPasswordField').value,
        'Test Duration': document.getElementById('testDuration').value
    };
    showStatus('settingsStatus', 'Saving...', 'info');
    try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        if (result.success) {
            showStatus('settingsStatus', 'Settings saved successfully! Please refresh to use new credentials.', 'success');
        } else {
            showStatus('settingsStatus', 'Error: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showStatus('settingsStatus', 'Error saving: ' + error.message, 'error');
    }
}

function stripLatexPreamble(latexContent) {
    if (!latexContent) return '';
    let content = latexContent;
    content = content.replace(/\\documentclass\{[^}]+\}/g, '');
    content = content.replace(/\\usepackage\{[^}]+\}/g, '');
    content = content.replace(/\\title\{[^}]*\}/g, '');
    content = content.replace(/\\author\{[^}]*\}/g, '');
    content = content.replace(/\\date\{[^}]*\}/g, '');
    content = content.replace(/\\maketitle/g, '');
    const docMatch = content.match(/\\begin\{document\}([\s\S]*)\\end\{document\}/);
    if (docMatch) content = docMatch[1].trim();
    return content;
}

function updateLatexPreview(rowIndex) {
    if (latexUpdateTimers[rowIndex]) clearTimeout(latexUpdateTimers[rowIndex]);
    latexUpdateTimers[rowIndex] = setTimeout(() => {
        const input = document.getElementById(`feedback_latex_${rowIndex}`).value;
        const preview = document.getElementById(`feedback_preview_${rowIndex}`);
        if (!input.trim()) {
            preview.innerHTML = '<p style="color: #999;">Your formatted feedback will appear here...</p>';
            return;
        }
        const content = stripLatexPreamble(input);
        preview.innerHTML = content || '<p style="color: #999;">Write your feedback...</p>';
        if (window.MathJax && window.MathJax.typesetPromise) {
            MathJax.typesetClear([preview]);
            MathJax.typesetPromise([preview]).catch((err) => {
                console.error('MathJax error:', err);
                preview.innerHTML += '<p style="color: #dc3545; font-size: 12px; margin-top: 10px;"><strong>LaTeX Error:</strong> Check your syntax</p>';
            });
        }
    }, 500);
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}m ${secs}s`;
}

async function loadSubmissions() {
    if (!isAuthenticated) return;
    const container = document.getElementById('submissionsContainer');
    container.innerHTML = '<p style="color: #666;">Loading submissions...</p>';
    try {
        const response = await fetch(`${SCRIPT_URL}?action=getSubmissions`);
        const submissions = await response.json();
        cachedSubmissions = submissions;
        if (submissions.error) {
            showStatus('submissionsStatus', 'Error: ' + submissions.error, 'error');
            return;
        }
        if (submissions.length === 0) {
            container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No submissions yet.</p>';
            return;
        }
        const studentFilter = document.getElementById('filterStudent');
        const uniqueStudents = [...new Set(submissions.map(s => s.studentEmail))];
        studentFilter.innerHTML = '<option value="all">All Students</option>';
        uniqueStudents.forEach(email => {
            const sub = submissions.find(s => s.studentEmail === email);
            studentFilter.innerHTML += `<option value="${email}">${sub.studentName} (${email})</option>`;
        });
        filterSubmissions();
    } catch (error) {
        showStatus('submissionsStatus', 'Error loading submissions: ' + error.message, 'error');
        container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px;">Error loading submissions</p>';
    }
}

function filterSubmissions() {
    const dayFilter = document.getElementById('filterDay').value;
    const studentFilter = document.getElementById('filterStudent').value;
    filteredSubmissions = cachedSubmissions.filter(sub => {
        const dayMatch = dayFilter === 'all' || sub.day == dayFilter;
        const studentMatch = studentFilter === 'all' || sub.studentEmail === studentFilter;
        return dayMatch && studentMatch;
    });
    filteredSubmissions.reverse();
    if (filteredSubmissions.length === 0) {
        document.getElementById('submissionsContainer').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No submissions match the filters.</p>';
        document.getElementById('navControls').style.display = 'none';
        return;
    }
    currentSubmissionIndex = 0;
    populateSubmissionSelector();
    document.getElementById('navControls').style.display = 'flex';
    displayCurrentSubmission();
}

function populateSubmissionSelector() {
    const selector = document.getElementById('submissionSelector');
    selector.innerHTML = '';
    filteredSubmissions.forEach((sub, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${sub.studentName} - Day ${sub.day} - ${new Date(sub.timestamp).toLocaleDateString()}`;
        selector.appendChild(option);
    });
    selector.value = currentSubmissionIndex;
}

function selectSubmission() {
    currentSubmissionIndex = parseInt(document.getElementById('submissionSelector').value);
    displayCurrentSubmission();
}

function navigateSubmission(direction) {
    currentSubmissionIndex += direction;
    if (currentSubmissionIndex < 0) currentSubmissionIndex = 0;
    if (currentSubmissionIndex >= filteredSubmissions.length) currentSubmissionIndex = filteredSubmissions.length - 1;
    document.getElementById('submissionSelector').value = currentSubmissionIndex;
    displayCurrentSubmission();
}

function displayCurrentSubmission() {
    const container = document.getElementById('submissionsContainer');
    const sub = filteredSubmissions[currentSubmissionIndex];
    if (!sub) return;
    document.getElementById('prevBtn').disabled = currentSubmissionIndex === 0;
    document.getElementById('nextBtn').disabled = currentSubmissionIndex === filteredSubmissions.length - 1;
    const timestamp = new Date(sub.timestamp).toLocaleString();
    let exitLogs = [];
    try {
        exitLogs = typeof sub.exitLogs === 'string' ? JSON.parse(sub.exitLogs) : sub.exitLogs || [];
    } catch (e) {
        exitLogs = [];
    }
    let violationDetails = '';
    if (exitLogs.length > 0) {
        violationDetails = '<div class="violation-details"><strong>Violations:</strong><ul>';
        exitLogs.forEach(log => {
            const logTime = new Date(log.time).toLocaleTimeString();
            violationDetails += `<li>${logTime}: ${log.type}</li>`;
        });
        violationDetails += '</ul></div>';
    }
    const q1Points = sub.q1_correct ? 5 : 0;
    const q2Points = sub.q2_correct ? 5 : 0;
    const q3Points = sub.q3_score || 0;
    const totalPoints = q1Points + q2Points + parseInt(q3Points);
    const isGraded = sub.q3_score !== '' && sub.q3_score !== null && sub.q3_score !== undefined;
    const gradedBadge = isGraded ? '<span class="graded-badge graded">Graded</span>' : '<span class="graded-badge pending">Pending</span>';
    const q3AnswerRendered = stripLatexPreamble(sub.q3_answer || '');
    
    const overrideSection = `
        <div class="override-controls">
            <h4>Override Auto-Graded Questions:</h4>
            <div style="margin-top: 10px;">
                <strong>Q1 (Currently: ${sub.q1_correct ? 'Correct' : 'Incorrect'}):</strong>
                <div class="override-buttons" style="margin-top: 5px;">
                    <button class="override-btn correct" onclick="overrideScore(${sub.rowIndex}, 1, true)">Mark Correct</button>
                    <button class="override-btn incorrect" onclick="overrideScore(${sub.rowIndex}, 1, false)">Mark Incorrect</button>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <strong>Q2 (Currently: ${sub.q2_correct ? 'Correct' : 'Incorrect'}):</strong>
                <div class="override-buttons" style="margin-top: 5px;">
                    <button class="override-btn correct" onclick="overrideScore(${sub.rowIndex}, 2, true)">Mark Correct</button>
                    <button class="override-btn incorrect" onclick="overrideScore(${sub.rowIndex}, 2, false)">Mark Incorrect</button>
                </div>
            </div>
        </div>
    `;
    
    const feedbackSection = `
        <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #EA5A2F;">
            <h4 style="margin-bottom: 15px; color: #EA5A2F;">Question 3 Grading</h4>
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: 600; margin-bottom: 5px;">Score (out of 10):</label>
                <input type="number" id="score_${sub.rowIndex}" min="0" max="10" step="1" value="${sub.q3_score || ''}" style="width: 100px; padding: 8px; border: 2px solid #E3E3E3; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px; margin-top: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 10px;">Feedback (LaTeX Supported):</label>
                <div class="latex-editor-container">
                    <div class="latex-input-section">
                        <h4>LaTeX Code</h4>
                        <textarea id="feedback_latex_${sub.rowIndex}" oninput="updateLatexPreview(${sub.rowIndex})" placeholder="Write your feedback using LaTeX here...">${sub.q3_feedback || ''}</textarea>
                    </div>
                    <div class="latex-preview-section">
                        <h4>Live Preview</h4>
                        <div id="feedback_preview_${sub.rowIndex}" class="preview-content">Your formatted feedback will appear here...</div>
                    </div>
                </div>
            </div>
            <button onclick="saveFeedback(${sub.rowIndex})" class="btn" style="width: auto; padding: 10px 20px;">Save Feedback & Notify Student</button>
        </div>
    `;
    
    container.innerHTML = `
        <div class="submission-card">
            <div class="submission-header">
                <h3>${sub.studentName} ${gradedBadge}</h3>
                <span style="color: #666;">Day ${sub.day}</span>
            </div>
            <div class="submission-details">
                <div class="detail-item"><span class="detail-label">Email:</span> ${sub.studentEmail}</div>
                <div class="detail-item"><span class="detail-label">Submitted:</span> ${timestamp}</div>
                <div class="detail-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;"><strong style="font-size: 18px; color: #EA5A2F;">Total Score: ${totalPoints}/20</strong></div>
                <div class="detail-item"><span class="detail-label">Q1 (5 points):</span> <span class="${sub.q1_correct ? 'correct' : 'incorrect'}">${sub.q1_correct ? 'Correct (+5 pts)' : 'Incorrect (0 pts)'}</span> (Answer: ${sub.q1_answer}) - Time: ${formatTime(sub.q1_time)}</div>
                <div class="detail-item"><span class="detail-label">Q2 (5 points):</span> <span class="${sub.q2_correct ? 'correct' : 'incorrect'}">${sub.q2_correct ? 'Correct (+5 pts)' : 'Incorrect (0 pts)'}</span> (Answer: ${sub.q2_answer}) - Time: ${formatTime(sub.q2_time)}</div>
                <div class="detail-item"><span class="detail-label">Q3 Score (10 points):</span> ${sub.q3_score !== '' && sub.q3_score !== null && sub.q3_score !== undefined ? `${sub.q3_score}/10 (+${sub.q3_score} pts)` : 'Not graded yet'}</div>
                <div class="detail-item"><span class="detail-label">Q3 Time:</span> ${formatTime(sub.q3_time)}</div>
                <div class="detail-item"><span class="detail-label">Q3 Answer (Student's LaTeX):</span> <div id="student_answer_${sub.rowIndex}" style="margin-top: 10px; padding: 15px; background: white; border-radius: 4px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; border: 2px solid #E3E3E3;">${q3AnswerRendered}</div></div>
                <div class="detail-item"><span class="detail-label">Total Time:</span> ${formatTime(sub.totalTime)}</div>
                <div class="detail-item"><span class="detail-label">Exit Count:</span> <span style="color: ${sub.exitCount > 0 ? '#dc3545' : '#28a745'}; font-weight: bold;">${sub.exitCount}</span></div>
                ${violationDetails}
            </div>
            ${overrideSection}
            ${feedbackSection}
        </div>
    `;
    
    if (window.MathJax) {
        setTimeout(() => {
            const answerDiv = document.getElementById(`student_answer_${sub.rowIndex}`);
            if (answerDiv) {
                MathJax.typesetPromise([answerDiv]).catch(e => console.log(e));
            }
        }, 100);
    }
    if (sub.q3_feedback) {
        setTimeout(() => updateLatexPreview(sub.rowIndex), 100);
    }
    showStatus('submissionsStatus', `Viewing submission ${currentSubmissionIndex + 1} of ${filteredSubmissions.length}`, 'info');
}

async function overrideScore(rowIndex, questionNum, isCorrect) {
    if (!confirm(`Are you sure you want to mark Q${questionNum} as ${isCorrect ? 'CORRECT' : 'INCORRECT'}?`)) {
        return;
    }
    const data = { action: 'overrideScore', rowIndex: rowIndex, questionNum: questionNum, isCorrect: isCorrect };
    try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        if (result.success) {
            alert(`Q${questionNum} marked as ${isCorrect ? 'correct' : 'incorrect'}!`);
            loadSubmissions();
        } else {
            alert('Error: ' + (result.error || 'Failed to override score'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function saveFeedback(rowIndex) {
    const scoreInput = document.getElementById(`score_${rowIndex}`);
    const score = scoreInput.value;
    const feedback = document.getElementById(`feedback_latex_${rowIndex}`).value;
    if (!score || !feedback) {
        alert('Please enter both score and feedback');
        return;
    }
    const scoreNum = parseInt(score);
    if (isNaN(scoreNum) || scoreNum < 0 || scoreNum > 10) {
        alert('Score must be a whole number between 0 and 10');
        return;
    }
    scoreInput.value = scoreNum;
    const data = { action: 'updateFeedback', rowIndex: rowIndex, q3_score: scoreNum, q3_feedback: feedback };
    try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        if (result.success) {
            alert('Feedback saved and student notified!');
            loadSubmissions();
        } else {
            alert('Error: ' + (result.error || 'Failed to save feedback'));
        }
    } catch (error) {
        alert('Error saving feedback: ' + error.message);
    }
}

function exportToCSV() {
    if (!isAuthenticated) return;
    if (cachedSubmissions.length === 0) {
        alert('No submissions to export. Please load submissions first.');
        return;
    }
    const headers = ['Student Name','Email','Day','Timestamp','Q1 Answer','Q1 Correct','Q1 Points','Q1 Time (s)','Q2 Answer','Q2 Correct','Q2 Points','Q2 Time (s)','Q3 Answer','Q3 Time (s)','Q3 Score','Q3 Feedback','Total Points','Total Time (s)','Exit Count','Violations'];
    const rows = cachedSubmissions.map(sub => {
        let exitLogs = [];
        try {
            exitLogs = typeof sub.exitLogs === 'string' ? JSON.parse(sub.exitLogs) : sub.exitLogs || [];
        } catch (e) {
            exitLogs = [];
        }
        const violations = exitLogs.map(log => `${log.time}: ${log.type}`).join('; ');
        const q1Points = sub.q1_correct ? 5 : 0;
        const q2Points = sub.q2_correct ? 5 : 0;
        const q3Points = sub.q3_score || 0;
        const totalPoints = q1Points + q2Points + parseInt(q3Points);
        return [sub.studentName,sub.studentEmail,sub.day,sub.timestamp,sub.q1_answer,sub.q1_correct,q1Points,sub.q1_time,sub.q2_answer,sub.q2_correct,q2Points,sub.q2_time,`"${sub.q3_answer.replace(/"/g, '""')}"`,sub.q3_time,sub.q3_score || '',`"${(sub.q3_feedback || '').replace(/"/g, '""')}"`,totalPoints,sub.totalTime,sub.exitCount,`"${violations}"`];
    });
    const csv = [headers.join(','),...rows.map(row => row.join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dpotd_submissions_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

async function loadUsers() {
    if (!isAuthenticated) return;
    const container = document.getElementById('usersContainer');
    container.innerHTML = '<p style="color: #666;">Loading users...</p>';
    try {
        const response = await fetch(`${SCRIPT_URL}?action=getUsers`);
        const users = await response.json();
        if (users.error) {
            showStatus('usersStatus', 'Error: ' + users.error, 'error');
            return;
        }
        if (users.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666;">No users registered yet.</p>';
            return;
        }
        container.innerHTML = '';
        users.forEach(user => {
            const card = document.createElement('div');
            card.className = 'submission-card';
            const createdDate = new Date(user.created).toLocaleString();
            card.innerHTML = `
                <div class="submission-header">
                    <h3>${user.name}</h3>
                    <button onclick="deleteUser('${user.email}')" class="btn" style="width: auto; padding: 8px 16px; background: #dc3545; font-size: 14px;">Delete User</button>
                </div>
                <div class="submission-details">
                    <div class="detail-item"><span class="detail-label">Email:</span> ${user.email}</div>
                    <div class="detail-item"><span class="detail-label">Password:</span> ${user.password}</div>
                    <div class="detail-item"><span class="detail-label">Registered:</span> ${createdDate}</div>
                </div>
            `;
            container.appendChild(card);
        });
        showStatus('usersStatus', `Loaded ${users.length} user(s)`, 'success');
    } catch (error) {
        showStatus('usersStatus', 'Error loading users: ' + error.message, 'error');
        container.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 40px;">Error loading users</p>';
    }
}

async function addUser() {
    const name = document.getElementById('newUserName').value.trim();
    const email = document.getElementById('newUserEmail').value.trim();
    
    if (!name || !email) {
        showStatus('usersStatus', 'Please fill in both name and email', 'error');
        return;
    }
    
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showStatus('usersStatus', 'Invalid email format', 'error');
        return;
    }
    
    showStatus('usersStatus', 'Adding user and generating password...', 'info');
    
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'adminAddUser', name: name, email: email })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showStatus('usersStatus', `User added successfully! Generated password: ${result.generatedPassword} (also emailed to user)`, 'success');
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserEmail').value = '';
            loadUsers();
        } else {
            showStatus('usersStatus', 'Error: ' + (result.error || 'Failed to add user'), 'error');
        }
    } catch (error) {
        showStatus('usersStatus', 'Error: ' + error.message, 'error');
    }
}

async function deleteUser(email) {
    if (!confirm(`Are you sure you want to delete the user with email: ${email}?\n\nThis will also delete all their test submissions!`)) {
        return;
    }
    try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteUser', email: email }) });
        const result = await response.json();
        if (result.success) {
            showStatus('usersStatus', 'User deleted successfully!', 'success');
            loadUsers();
        } else {
            showStatus('usersStatus', 'Error: ' + (result.error || 'Failed to delete user'), 'error');
        }
    } catch (error) {
        showStatus('usersStatus', 'Error: ' + error.message, 'error');
    }
}

window.addEventListener('load', () => {
    if (!SCRIPT_URL || SCRIPT_URL.includes('YOUR_DEPLOYMENT_ID')) {
        alert('Please update the SCRIPT_URL with your Google Apps Script deployment URL');
    }
    document.getElementById('usernameInput').focus();
});
    </script>
</body>
</html>
