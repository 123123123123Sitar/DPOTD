<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.PotD Student Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #E3E3E3;
            min-height: 100vh;
            padding: 20px;
        }

        body.locked {
            padding: 0;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 2px solid #E3E3E3;
        }

        body.locked .container {
            max-width: 100%;
            height: 100vh;
            border-radius: 0;
            overflow-y: auto;
            padding: 80px 40px 40px;
            margin: 0;
        }

        h1 {
            color: #000;
            margin-bottom: 10px;
            text-align: center;
            font-size: 2.2em;
            font-weight: 700;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #000;
            font-weight: 600;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #E3E3E3;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: #fff;
            color: #000;
            font-family: 'Courier New', monospace;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #EA5A2F;
            box-shadow: 0 0 0 3px rgba(234, 90, 47, 0.1);
        }

        .btn {
            background: #EA5A2F;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            background: #d84a1f;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #E3E3E3;
            color: #666;
        }

        .status {
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .question-section {
            display: none;
        }

        .question-box {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #EA5A2F;
            min-height: 200px;
        }

        .question-box h2 {
            color: #000;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .question-box p {
            color: #333;
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .latex-editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .latex-input-section, .latex-preview-section {
            background: #fff;
            border: 2px solid #E3E3E3;
            border-radius: 8px;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
        }

        .latex-input-section h3, .latex-preview-section h3 {
            color: #EA5A2F;
            margin-bottom: 10px;
            font-size: 16px;
        }

        #latexInput {
            width: 100%;
            height: calc(100% - 40px);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: none;
        }

        #latexPreview {
            min-height: calc(100% - 40px);
            padding: 10px;
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow-y: auto;
        }

        .timer {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 18px;
            font-weight: 600;
            color: #000;
            z-index: 10000;
            border: 2px solid #E3E3E3;
        }

        .progress-indicator {
            position: fixed;
            top: 80px;
            left: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 16px;
            font-weight: 600;
            color: #EA5A2F;
            z-index: 10000;
            border: 2px solid #E3E3E3;
        }

        .ai-helper {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 2px solid #E3E3E3;
            z-index: 10001;
            display: none;
        }

        .ai-helper.show {
            display: block;
        }

        .ai-header {
            background: #EA5A2F;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 25px;
            height: 25px;
        }

        .ai-chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }

        .ai-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 90%;
        }

        .ai-message.user {
            background: #EA5A2F;
            color: white;
            margin-left: auto;
        }

        .ai-message.assistant {
            background: white;
            border: 1px solid #E3E3E3;
        }

        .ai-input-container {
            padding: 15px;
            border-top: 2px solid #E3E3E3;
        }

        .ai-input-container input {
            width: 100%;
            padding: 10px;
            border: 2px solid #E3E3E3;
            border-radius: 6px;
            font-size: 14px;
        }

        .ai-toggle-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #EA5A2F;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
        }

        .warning-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(234, 90, 47, 0.95);
            z-index: 99999;
            color: white;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            padding: 20px;
        }

        .warning-overlay.show {
            display: flex;
        }

        .warning-count {
            font-size: 48px;
            color: #000;
            margin: 20px 0;
        }

        .loading-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-modal.show {
            display: flex;
        }
        
        .loading-content {
            background: white;
            padding: 40px 60px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #EA5A2F;
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            display: block;
            margin-top: 5px;
        }

        .day-indicator {
            background: #EA5A2F;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 18px;
            display: inline-block;
            margin-bottom: 20px;
        }

        .correct {
            color: #28a745;
        }

        .incorrect {
            color: #dc3545;
        }

        body.locked::after {
            content: 'TEST IN PROGRESS - DO NOT LEAVE THIS PAGE';
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            z-index: 9999;
            font-size: 14px;
        }

        @media (max-width: 1200px) {
            .latex-editor-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Modal -->
    <div class="loading-modal" id="loadingModal">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Loading...</p>
        </div>
    </div>

    <!-- Warning Overlay -->
    <div class="warning-overlay" id="warningOverlay">
        <p><strong>‚ö†Ô∏è WARNING: YOU HAVE LEFT THE TEST PAGE!</strong></p>
        <p style="font-size: 18px; margin: 20px 0;">Return to the test immediately!</p>
        <p class="warning-count">Violations recorded: <span id="violationCount">0</span></p>
        <button class="btn" onclick="returnToFullscreen()" style="max-width: 400px; padding: 20px 40px; font-size: 18px; margin-top: 20px; background: #fff; color: #dc3545; border: 3px solid #fff;">
            üîí Return to Test & Enter Fullscreen
        </button>
    </div>

    <!-- AI Helper Toggle Button -->
    <button class="ai-toggle-btn" id="aiToggleBtn" onclick="toggleAIHelper()" style="display: none;">
        ü§ñ LaTeX Helper
    </button>

    <!-- AI Helper Panel -->
    <div class="ai-helper" id="aiHelper">
        <div class="ai-header">
            <span>ü§ñ LaTeX Helper</span>
            <button class="ai-close" onclick="toggleAIHelper()">√ó</button>
        </div>
        <div class="ai-chat-container" id="aiChatContainer">
            <div class="ai-message assistant">
                <strong>LaTeX Helper:</strong> Hi! I can help you with LaTeX syntax and formatting. Ask me things like "How do I write a fraction?" or "How do I make superscripts?"
                <br><br>
                <em>‚ö†Ô∏è I can only help with LaTeX syntax questions. I cannot help solve the math problem or provide answers.</em>
            </div>
        </div>
        <div class="ai-input-container">
            <input type="text" id="aiInput" placeholder="Ask about LaTeX syntax..." onkeypress="handleAIEnter(event)">
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <h1>D.PotD Problems of the Day</h1>
        <p class="subtitle">Student Portal</p>
        
        <!-- Student Form -->
        <div id="studentForm">
            <div class="form-group">
                <label>Full Name:</label>
                <input type="text" id="studentName" required>
            </div>
            
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="studentEmail" required>
                <span id="emailError" class="error-message"></span>
            </div>
            
            <button class="btn" onclick="startTest()">Start Test</button>
            <div id="startStatus" class="status"></div>
        </div>
        
        <!-- Question Sections -->
        <div id="questionSection" class="question-section">
            <div class="timer" id="timer">Time Remaining: 2:00:00</div>
            <div class="progress-indicator" id="progressIndicator">Question 1 of 3</div>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <div class="day-indicator" id="dayIndicator">Day -</div>
                <div style="margin-top: 15px; font-size: 14px; color: #666;">
                    <span style="margin-right: 15px;">‚è∞ 2 hours total</span>
                    <span style="margin-right: 15px;">üìù 3 questions</span>
                    <span>üîí Do not leave this page</span>
                </div>
            </div>

            <!-- Question 1 Page -->
            <div id="q1Page" style="display: none;">
                <div class="question-box">
                    <h2>Question 1</h2>
                    <p id="q1Text"></p>
                    <input type="text" id="q1Answer" placeholder="Your answer (numbers only)">
                </div>
                <button class="btn" onclick="nextQuestion(1)">Next Question ‚Üí</button>
                <div id="q1Status" class="status"></div>
            </div>

            <!-- Question 2 Page -->
            <div id="q2Page" style="display: none;">
                <div class="question-box">
                    <h2>Question 2</h2>
                    <p id="q2Text"></p>
                    <input type="text" id="q2Answer" placeholder="Your answer (numbers only)">
                </div>
                <button class="btn" onclick="nextQuestion(2)">Next Question ‚Üí</button>
                <div id="q2Status" class="status"></div>
            </div>

            <!-- Question 3 Page with LaTeX Editor -->
            <div id="q3Page" style="display: none;">
                <div class="question-box">
                    <h2>Question 3 (Proof/Explanation)</h2>
                    <p id="q3Text"></p>
                </div>
                
                <div class="latex-editor-container">
                    <div class="latex-input-section">
                        <h3>üìù LaTeX Code</h3>
                        <textarea id="latexInput" placeholder="Write your proof using LaTeX here...

Examples:
\frac{a}{b} for fractions
x^2 for superscripts
x_i for subscripts
\sqrt{x} for square root
\sum_{i=1}^{n} for summation
\int_{a}^{b} for integrals

Use \\ for new lines"></textarea>
                    </div>
                    <div class="latex-preview-section">
                        <h3>üëÅÔ∏è Live Preview</h3>
                        <div id="latexPreview">Your formatted proof will appear here...</div>
                    </div>
                </div>
                
                <button class="btn" onclick="submitTest()" style="margin-top: 20px;">Submit Test</button>
                <div id="q3Status" class="status"></div>
            </div>
        </div>
    </div>
    
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzRPyEM0A2oP_zU9GTq_tPintK4rU1e16IvGLgCV-P1G4-dsghsw7B_kkgAuPII56X0/exec';
        
        // REPLACE THIS WITH YOUR ACTUAL GEMINI API KEY
        const GEMINI_API_KEY = 'AIzaSyA-sQC6ZR0Fqrev5w0KfuHVTj2p-4ZS8uc';
        
        let startTime;
        let timerInterval;
        let questionsData;
        let q1StartTime, q2StartTime, q3StartTime;
        let q1EndTime, q2EndTime, q3EndTime;
        let exitCount = 0;
        let exitLogs = [];
        let testActive = false;
        let currentDay = null;
        let currentQuestion = 0;
        
        const TEST_DURATION = 120 * 60 * 1000;

        // LaTeX Preview Update
        function updateLatexPreview() {
            const input = document.getElementById('latexInput').value;
            const preview = document.getElementById('latexPreview');
            
            if (input.trim() === '') {
                preview.innerHTML = 'Your formatted proof will appear here...';
                return;
            }
            
            preview.innerHTML = '$$' + input + '$$';
            
            if (window.MathJax) {
                MathJax.typesetPromise([preview]).catch((err) => console.log('MathJax error:', err));
            }
        }

        // AI Helper Functions
        function toggleAIHelper() {
            const helper = document.getElementById('aiHelper');
            helper.classList.toggle('show');
        }

        function handleAIEnter(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Check if API key is set
            if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                addAIMessage('‚ö†Ô∏è Error: Gemini API key is not configured. Please add your API key to the code.', 'assistant');
                input.value = '';
                return;
            }
            
            addAIMessage(message, 'user');
            input.value = '';
            
            const systemPrompt = `You are a LaTeX syntax helper for a math competition. You can ONLY help with LaTeX formatting and syntax questions.

STRICT RULES:
1. ONLY answer questions about LaTeX syntax, commands, and formatting
2. DO NOT solve math problems or provide mathematical answers
3. DO NOT provide hints or guidance on how to solve the problem
4. DO NOT discuss the content of the math question
5. If asked anything other than LaTeX syntax, politely decline and redirect

Examples of ALLOWED questions:
- "How do I write a fraction in LaTeX?"
- "What's the command for square root?"
- "How do I make subscripts?"
- "How do I align equations?"

Examples of FORBIDDEN questions:
- "How do I solve this problem?"
- "What's the answer?"
- "Can you give me a hint?"
- "Is my approach correct?"

If the user asks a forbidden question, respond with: "I can only help with LaTeX syntax and formatting. I cannot help solve the problem or discuss mathematical approaches. Please ask about LaTeX commands instead."`;

            try {
                console.log('Sending request to Gemini API...');
                console.log('API Key present:', GEMINI_API_KEY && GEMINI_API_KEY !== 'YOUR_GEMINI_API_KEY_HERE');
                
                const requestBody = {
                    contents: [{
                        parts: [{
                            text: `${systemPrompt}\n\nUser: ${message}\n\nAssistant:`
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 200,
                    }
                };
                
                console.log('Request body:', JSON.stringify(requestBody, null, 2));
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Gemini API error response:', errorData);
                    
                    if (response.status === 400) {
                        addAIMessage('‚ö†Ô∏è Invalid API key or request. Status: 400. Check console for details.', 'assistant');
                    } else if (response.status === 403) {
                        addAIMessage('‚ö†Ô∏è API key error (403 Forbidden). Your API key may be invalid or restricted.', 'assistant');
                    } else {
                        addAIMessage(`Sorry, API error (${response.status}). Check console for details.`, 'assistant');
                    }
                    return;
                }
                
                const data = await response.json();
                console.log('Gemini response:', data);
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    console.error('Unexpected Gemini response format:', data);
                    addAIMessage('Sorry, I received an unexpected response. Please try again.', 'assistant');
                    return;
                }
                
                const aiResponse = data.candidates[0].content.parts[0].text;
                console.log('AI response text:', aiResponse);
                
                addAIMessage(aiResponse, 'assistant');
            } catch (error) {
                console.error('AI Error full details:', error);
                addAIMessage(`Error: ${error.message}. Check console for details.`, 'assistant');
            }
        }

        function addAIMessage(message, type) {
            const container = document.getElementById('aiChatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${type}`;
            
            if (type === 'assistant') {
                messageDiv.innerHTML = `<strong>LaTeX Helper:</strong> ${message}`;
            } else {
                messageDiv.textContent = message;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = 'status ' + type;
            el.style.display = 'block';
        }

        function showLoading(message) {
            const modal = document.getElementById('loadingModal');
            const text = document.getElementById('loadingText');
            text.textContent = message;
            modal.classList.add('show');
        }

        function hideLoading() {
            const modal = document.getElementById('loadingModal');
            modal.classList.remove('show');
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function cleanAnswer(answer) {
            return answer.replace(/[^0-9-]/g, '').replace(/(?!^)-/g, '');
        }

        function recordViolation(type) {
            if (!testActive) return;
            
            exitCount++;
            exitLogs.push({
                time: new Date().toISOString(),
                type: type
            });
            
            document.getElementById('violationCount').textContent = exitCount;
            
            const overlay = document.getElementById('warningOverlay');
            const warningText = overlay.querySelector('p:first-child');
            
            if (type === 'exited_fullscreen') {
                warningText.innerHTML = '<strong>‚ö†Ô∏è WARNING: YOU EXITED FULLSCREEN MODE!</strong>';
            } else if (type === 'tab_hidden') {
                warningText.innerHTML = '<strong>‚ö†Ô∏è WARNING: YOU SWITCHED TABS!</strong>';
            } else {
                warningText.innerHTML = '<strong>‚ö†Ô∏è WARNING: YOU LEFT THE TEST PAGE!</strong>';
            }
            
            overlay.classList.add('show');
        }

        function hideWarning() {
            const overlay = document.getElementById('warningOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        function returnToFullscreen() {
            document.documentElement.requestFullscreen().then(() => {
                console.log('Returned to fullscreen');
                hideWarning();
            }).catch((err) => {
                alert('Please allow fullscreen mode to continue the test.');
                console.error('Fullscreen error:', err);
            });
        }

        function handleFullscreenChange() {
            if (!document.fullscreenElement && testActive) {
                recordViolation('exited_fullscreen');
                const overlay = document.getElementById('warningOverlay');
                overlay.classList.add('show');
                
                setTimeout(() => {
                    document.documentElement.requestFullscreen().then(() => {
                        console.log('Re-entered fullscreen');
                        hideWarning();
                    }).catch((err) => {
                        console.error('Failed to re-enter fullscreen:', err);
                    });
                }, 100);
            } else if (document.fullscreenElement && testActive) {
                hideWarning();
            }
        }

        function handleVisibilityChange() {
            if (document.hidden && testActive) {
                recordViolation('tab_hidden');
                const overlay = document.getElementById('warningOverlay');
                overlay.classList.add('show');
            } else if (!document.hidden && testActive) {
                hideWarning();
            }
        }

        function handleWindowBlur() {
            if (testActive) {
                recordViolation('window_blur');
                const overlay = document.getElementById('warningOverlay');
                overlay.classList.add('show');
            }
        }

        function handleWindowFocus() {
            if (testActive) {
                hideWarning();
            }
        }

        function monitorFullscreen() {
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('blur', handleWindowBlur);
            window.addEventListener('focus', handleWindowFocus);
        }

        document.addEventListener('keydown', function(e) {
            if (testActive) {
                if ((e.ctrlKey && e.keyCode === 9) || 
                    (e.ctrlKey && e.shiftKey && e.keyCode === 9) ||
                    (e.altKey && e.keyCode === 9) ||
                    (e.metaKey && e.keyCode === 9) ||
                    (e.metaKey && e.keyCode === 192) ||
                    (e.ctrlKey && (e.keyCode >= 49 && e.keyCode <= 57)) ||
                    (e.metaKey && (e.keyCode >= 49 && e.keyCode <= 57)) ||
                    e.keyCode === 123 ||
                    (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) ||
                    (e.ctrlKey && e.keyCode === 85) ||
                    (e.ctrlKey && e.keyCode === 83) ||
                    (e.ctrlKey && e.keyCode === 80) ||
                    (e.metaKey && e.altKey && (e.keyCode === 73 || e.keyCode === 74)) ||
                    (e.altKey && e.keyCode === 37) ||
                    (e.altKey && e.keyCode === 39) ||
                    (e.ctrlKey && e.keyCode === 87) ||
                    (e.metaKey && e.keyCode === 87) ||
                    e.keyCode === 27) {
                    e.preventDefault();
                    e.stopPropagation();
                    recordViolation('keyboard_shortcut_blocked');
                    return false;
                }
            }
        });

        document.addEventListener('keyup', function(e) {
            if (testActive && e.key === 'PrintScreen') {
                navigator.clipboard.writeText('');
                recordViolation('screenshot_attempt');
            }
        });

        document.addEventListener('contextmenu', function(e) {
            if (testActive) {
                e.preventDefault();
                recordViolation('right_click');
            }
        });

        window.addEventListener('beforeunload', function(e) {
            if (testActive) {
                e.preventDefault();
                e.returnValue = '';
                recordViolation('attempted_close');
                return '';
            }
        });

        async function getCurrentDay() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getSchedule`);
                const schedule = await response.json();
                const now = new Date();
                let activeDay = null;
                
                for (let i = 1; i <= 5; i++) {
                    const dayStart = schedule[`day${i}`] ? new Date(schedule[`day${i}`]) : null;
                    const nextDay = schedule[`day${i + 1}`] ? new Date(schedule[`day${i + 1}`]) : null;
                    
                    if (dayStart && now >= dayStart) {
                        if (!nextDay || now < nextDay) {
                            activeDay = i;
                            break;
                        }
                    }
                }
                
                return activeDay;
            } catch (error) {
                console.error('Error getting current day:', error);
                return null;
            }
        }

        function updateTimer() {
            if (!startTime) return;
            
            const elapsed = Date.now() - startTime;
            const remaining = Math.max(0, TEST_DURATION - elapsed);
            
            const hours = Math.floor(remaining / (60 * 60 * 1000));
            const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
            const seconds = Math.floor((remaining % (60 * 1000)) / 1000);
            
            const timerEl = document.getElementById('timer');
            timerEl.textContent = `Time Remaining: ${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerEl.style.display = 'block';
            timerEl.style.color = '#000000';
            
            if (remaining < 10 * 60 * 1000) {
                timerEl.style.color = '#ff6b6b';
            }
            
            if (remaining <= 0) {
                clearInterval(timerInterval);
                submitTest(true);
            }
        }

        function showQuestion(questionNum) {
            document.getElementById('q1Page').style.display = 'none';
            document.getElementById('q2Page').style.display = 'none';
            document.getElementById('q3Page').style.display = 'none';
            
            document.getElementById(`q${questionNum}Page`).style.display = 'block';
            document.getElementById('progressIndicator').textContent = `Question ${questionNum} of 3`;
            currentQuestion = questionNum;
            
            const aiBtn = document.getElementById('aiToggleBtn');
            if (questionNum === 3) {
                aiBtn.style.display = 'block';
            } else {
                aiBtn.style.display = 'none';
                document.getElementById('aiHelper').classList.remove('show');
            }
        }

        function nextQuestion(fromQuestion) {
            const answer = document.getElementById(`q${fromQuestion}Answer`).value.trim();
            
            if (!answer) {
                showStatus(`q${fromQuestion}Status`, 'Please provide an answer before continuing', 'error');
                return;
            }
            
            if (fromQuestion === 1) {
                q1EndTime = Date.now();
                q2StartTime = Date.now();
                showQuestion(2);
            } else if (fromQuestion === 2) {
                q2EndTime = Date.now();
                q3StartTime = Date.now();
                showQuestion(3);
            }
        }

        async function startTest() {
            const name = document.getElementById('studentName').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const emailError = document.getElementById('emailError');
            
            emailError.textContent = '';
            
            if (!name || !email) {
                showStatus('startStatus', 'Please fill in all fields', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                emailError.textContent = 'Please enter a valid email address (e.g., student@example.com)';
                showStatus('startStatus', 'Invalid email format', 'error');
                return;
            }
            
            showLoading('Determining current day...');
            
            currentDay = await getCurrentDay();
            
            if (!currentDay) {
                hideLoading();
                showStatus('startStatus', 'No test is currently available. Please check the schedule.', 'error');
                return;
            }
            
            showLoading(`Loading Day ${currentDay} questions...`);
            
            try {
                const checkResponse = await fetch(`${SCRIPT_URL}?action=checkSubmission&email=${encodeURIComponent(email)}&day=${currentDay}`);
                const checkData = await checkResponse.json();
                
                if (checkData.exists) {
                    hideLoading();
                    showStatus('startStatus', 'You have already submitted this test!', 'error');
                    return;
                }
                
                showLoading('Loading questions...');
                const response = await fetch(`${SCRIPT_URL}?action=getQuestions&day=${currentDay}`);
                questionsData = await response.json();
                
                if (questionsData.error) {
                    hideLoading();
                    showStatus('startStatus', 'Error: ' + questionsData.error, 'error');
                    return;
                }
                
                document.getElementById('q1Text').textContent = questionsData.q1_text;
                document.getElementById('q2Text').textContent = questionsData.q2_text;
                document.getElementById('q3Text').textContent = questionsData.q3_text;
                document.getElementById('dayIndicator').textContent = `Day ${currentDay}`;
                
                hideLoading();
                
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn';
                confirmBtn.style.marginTop = '20px';
                confirmBtn.textContent = 'Enter Fullscreen & Begin Test';
                confirmBtn.onclick = async function() {
                    try {
                        await document.documentElement.requestFullscreen();
                        console.log('Entered fullscreen successfully');
                        
                        confirmBtn.remove();
                        
                        document.getElementById('studentForm').style.display = 'none';
                        document.getElementById('questionSection').style.display = 'block';
                        
                        document.body.classList.add('locked');
                        testActive = true;
                        monitorFullscreen();
                        
                        startTime = Date.now();
                        q1StartTime = Date.now();
                        timerInterval = setInterval(updateTimer, 1000);
                        updateTimer();
                        
                        showQuestion(1);
                    } catch (err) {
                        console.error('Fullscreen error:', err);
                        alert('Fullscreen mode is required to take the test. Please allow fullscreen and try again.');
                    }
                };
                
                const statusEl = document.getElementById('startStatus');
                statusEl.textContent = 'Questions loaded! Click below to enter fullscreen mode and begin.';
                statusEl.className = 'status success';
                statusEl.style.display = 'block';
                statusEl.parentElement.appendChild(confirmBtn);
                
                setTimeout(() => {
                    if (testActive) {
                        alert('Time is up! Your test will be submitted automatically.');
                        submitTest(true);
                    }
                }, TEST_DURATION);
                
            } catch (error) {
                hideLoading();
                showStatus('startStatus', 'Error connecting to server: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }

        async function submitTest(isForced = false) {
            if (!testActive && !isForced) {
                console.log('Test not active, submission blocked');
                return;
            }
            
            const name = document.getElementById('studentName').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const q1Answer = cleanAnswer(document.getElementById('q1Answer').value.trim());
            const q2Answer = cleanAnswer(document.getElementById('q2Answer').value.trim());
            const q3Answer = document.getElementById('latexInput').value.trim();
            
            if (!isForced && (!q1Answer || !q2Answer || !q3Answer)) {
                showStatus('q3Status', 'Please answer all questions', 'error');
                return;
            }
            
            testActive = false;
            clearInterval(timerInterval);
            
            const endTime = Date.now();
            q3EndTime = endTime;
            
            const q1Time = q1EndTime ? Math.floor((q1EndTime - q1StartTime) / 1000) : 0;
            const q2Time = q2EndTime && q2StartTime ? Math.floor((q2EndTime - q2StartTime) / 1000) : 0;
            const q3Time = q3StartTime ? Math.floor((q3EndTime - q3StartTime) / 1000) : 0;
            const totalTime = Math.floor((endTime - startTime) / 1000);
            
            const q1Correct = q1Answer === cleanAnswer(questionsData.q1_answer);
            const q2Correct = q2Answer === cleanAnswer(questionsData.q2_answer);
            
            const submission = {
                studentName: name,
                studentEmail: email,
                day: currentDay,
                q1_answer: q1Answer,
                q2_answer: q2Answer,
                q3_answer: q3Answer,
                q1_correct: q1Correct,
                q2_correct: q2Correct,
                q1_time: q1Time,
                q2_time: q2Time,
                q3_time: q3Time,
                totalTime: totalTime,
                exitCount: exitCount,
                exitLogs: JSON.stringify(exitLogs),
                workFileURL: ''
            };
            
            showLoading(isForced ? 'Auto-submitting test...' : 'Submitting your answers...');
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(submission)
                });
                
                const responseText = await response.text();
                const result = JSON.parse(responseText);
                
                hideLoading();
                
                if (result.success) {
                    testActive = false;
                    document.body.classList.remove('locked');
                    hideWarning();
                    
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                    
                    document.getElementById('questionSection').style.display = 'none';
                    
                    const resultsHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <h1 style="color: #28a745; margin-bottom: 20px;">‚úÖ Test Submitted Successfully!</h1>
                        <p style="font-size: 18px; color: #666; margin-bottom: 30px;">
                            Thanks for submitting! Your score will be emailed to you soon.
                        </p>
                        <div style="background: #f8f9fa; padding: 30px; border-radius: 8px; border-left: 4px solid #EA5A2F; max-width: 500px; margin: 0 auto;">
                            <h2 style="margin-bottom: 20px; color: #000;">Your Results</h2>
                            
                            <div style="text-align: left; margin-bottom: 15px;">
                                <strong style="color: #495057;">Question 1:</strong>
                                <span class="${q1Correct ? 'correct' : 'incorrect'}" style="font-size: 18px; margin-left: 10px;">
                                    ${q1Correct ? '‚úì Correct' : '‚úó Incorrect'}
                                </span>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    Your answer: ${q1Answer} | Time spent: ${Math.floor(q1Time / 60)}m ${q1Time % 60}s
                                </div>
                            </div>
                            
                            <div style="text-align: left; margin-bottom: 15px;">
                                <strong style="color: #495057;">Question 2:</strong>
                                <span class="${q2Correct ? 'correct' : 'incorrect'}" style="font-size: 18px; margin-left: 10px;">
                                    ${q2Correct ? '‚úì Correct' : '‚úó Incorrect'}
                                </span>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    Your answer: ${q2Answer} | Time spent: ${Math.floor(q2Time / 60)}m ${q2Time % 60}s
                                </div>
                            </div>
                            
                            <div style="text-align: left;">
                                <strong style="color: #495057;">Question 3:</strong>
                                <span style="color: #666; font-size: 14px; margin-left: 10px;">
                                    Will be graded manually
                                </span>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                    Time spent: ${Math.floor(q3Time / 60)}m ${q3Time % 60}s
                                </div>
                            </div>
                            
                            <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #E3E3E3;">
                                <strong style="color: #495057;">Total Time:</strong>
                                <span style="color: #000; font-size: 18px; margin-left: 10px;">
                                    ${Math.floor(totalTime / 60)} minutes ${totalTime % 60} seconds
                                </span>
                            </div>
                            
                            ${exitCount > 0 ? `
                            <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 6px;">
                                <strong style="color: #856404;">‚ö†Ô∏è Violations: ${exitCount}</strong>
                                <div style="color: #856404; font-size: 14px; margin-top: 5px;">
                                    These have been recorded and may affect your score.
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <button class="btn" onclick="window.location.reload()" style="max-width: 300px; margin: 30px auto 0;">
                            Back to Home
                        </button>
                    </div>
                    `;
                    
                    document.querySelector('.container').innerHTML = resultsHTML;
                } else {
                    showStatus('q3Status', 'Error: ' + (result.error || 'Unknown error'), 'error');
                    testActive = true;
                }
            } catch (error) {
                hideLoading();
                showStatus('q3Status', 'Error submitting: ' + error.message, 'error');
                console.error('Error:', error);
                testActive = true;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const numberInputs = ['q1Answer', 'q2Answer'];
            numberInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', function(e) {
                        const cleaned = cleanAnswer(e.target.value);
                        if (e.target.value !== cleaned) {
                            e.target.value = cleaned;
                        }
                    });
                }
            });
            
            const latexInput = document.getElementById('latexInput');
            if (latexInput) {
                latexInput.addEventListener('input', updateLatexPreview);
            }
        });
    </script>
</body>
</html>
